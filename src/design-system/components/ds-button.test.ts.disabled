import { describe, it, expect, beforeEach, afterEach } from 'vitest';
import './ds-button.ts';
import type { DSButton } from './ds-button';

// Helper function to dispatch events
const fireEvent = {
  click: (element: Element) => {
    const event = new MouseEvent('click', { bubbles: true, cancelable: true });
    element.dispatchEvent(event);
  },
  focus: (element: Element) => {
    const event = new FocusEvent('focus', { bubbles: true });
    element.dispatchEvent(event);
  },
  blur: (element: Element) => {
    const event = new FocusEvent('blur', { bubbles: true });
    element.dispatchEvent(event);
  },
  input: (element: Element) => {
    const event = new Event('input', { bubbles: true });
    element.dispatchEvent(event);
  }
};

describe('DSButton Component', () => {
  let container: HTMLElement;

  beforeEach(() => {
    container = document.createElement('div');
    document.body.appendChild(container);
  });

  afterEach(() => {
    document.body.removeChild(container);
  });

  describe('Rendering', () => {
    it('should render with default properties', async () => {
      container.innerHTML = '<ds-button></ds-button>';
      const button = container.querySelector('ds-button') as DSButton;
      
      await button.updateComplete;
      
      expect(button).toBeDefined();
      expect(button.text).toBe('Button');
      expect(button.variant).toBe('primary');
      expect(button.size).toBe('medium');
      expect(button.disabled).toBe(false);
    });

    it('should render with custom text', async () => {
      container.innerHTML = '<ds-button text="Custom Text"></ds-button>';
      const button = container.querySelector('ds-button') as DSButton;
      
      await button.updateComplete;
      
      const shadowButton = button.shadowRoot?.querySelector('button');
      expect(shadowButton?.textContent).toContain('Custom Text');
    });

    it('should apply correct variant classes', async () => {
      container.innerHTML = '<ds-button variant="secondary"></ds-button>';
      const button = container.querySelector('ds-button') as DSButton;
      
      await button.updateComplete;
      
      const shadowButton = button.shadowRoot?.querySelector('button');
      expect(shadowButton?.className).toContain('variant-secondary');
    });

    it('should apply correct size classes', async () => {
      container.innerHTML = '<ds-button size="large"></ds-button>';
      const button = container.querySelector('ds-button') as DSButton;
      
      await button.updateComplete;
      
      const shadowButton = button.shadowRoot?.querySelector('button');
      expect(shadowButton?.className).toContain('size-large');
    });
  });

  describe('Spectrum Token Integration', () => {
    it('should use Spectrum design tokens in CSS', async () => {
      container.innerHTML = '<ds-button></ds-button>';
      const button = container.querySelector('ds-button') as DSButton;
      
      await button.updateComplete;
      
      const styles = getComputedStyle(button);
      
      // Check that Spectrum tokens are applied
      expect(button.shadowRoot?.innerHTML).toContain('--ds-color-primary: var(--blue-500, #2680eb)');
      expect(button.shadowRoot?.innerHTML).toContain('--ds-font-sans: var(--font-family-sans');
      expect(button.shadowRoot?.innerHTML).toContain('--ds-transition-fast: var(--animation-duration-200');
    });

    it('should have proper fallback values for tokens', async () => {
      container.innerHTML = '<ds-button></ds-button>';
      const button = container.querySelector('ds-button') as DSButton;
      
      await button.updateComplete;
      
      // Verify fallback values are present
      expect(button.shadowRoot?.innerHTML).toContain('#2680eb'); // Blue-500 fallback
      expect(button.shadowRoot?.innerHTML).toContain('#1473e6'); // Blue-600 fallback
      expect(button.shadowRoot?.innerHTML).toContain('160ms'); // Animation fallback
    });
  });

  describe('States and Interactions', () => {
    it('should handle disabled state correctly', async () => {
      container.innerHTML = '<ds-button disabled></ds-button>';
      const button = container.querySelector('ds-button') as DSButton;
      
      await button.updateComplete;
      
      const shadowButton = button.shadowRoot?.querySelector('button');
      expect(shadowButton?.disabled).toBe(true);
      expect(button.disabled).toBe(true);
    });

    it('should handle loading state correctly', async () => {
      container.innerHTML = '<ds-button loading></ds-button>';
      const button = container.querySelector('ds-button') as DSButton;
      
      await button.updateComplete;
      
      expect(button.loading).toBe(true);
      const shadowButton = button.shadowRoot?.querySelector('button');
      expect(shadowButton?.disabled).toBe(true);
      
      // Should show loading spinner
      const spinner = button.shadowRoot?.querySelector('.loading-spinner');
      expect(spinner).toBeDefined();
    });

    it('should emit ds-click event when clicked', async () => {
      container.innerHTML = '<ds-button></ds-button>';
      const button = container.querySelector('ds-button') as DSButton;
      
      await button.updateComplete;
      
      let eventFired = false;
      let eventDetail: any = null;
      
      button.addEventListener('ds-click', (e: any) => {
        eventFired = true;
        eventDetail = e.detail;
      });
      
      const shadowButton = button.shadowRoot?.querySelector('button');
      shadowButton?.click();
      
      expect(eventFired).toBe(true);
      expect(eventDetail).toEqual({ variant: 'primary' });
    });

    it('should not emit event when disabled', async () => {
      container.innerHTML = '<ds-button disabled></ds-button>';
      const button = container.querySelector('ds-button') as DSButton;
      
      await button.updateComplete;
      
      let eventFired = false;
      
      button.addEventListener('ds-click', () => {
        eventFired = true;
      });
      
      const shadowButton = button.shadowRoot?.querySelector('button');
      shadowButton?.click();
      
      expect(eventFired).toBe(false);
    });
  });

  describe('Icons and Content', () => {
    it('should render icon when provided', async () => {
      container.innerHTML = '<ds-button icon="check" text="Save"></ds-button>';
      const button = container.querySelector('ds-button') as DSButton;
      
      await button.updateComplete;
      
      const icon = button.shadowRoot?.querySelector('.icon');
      expect(icon).toBeDefined();
      expect(icon?.textContent).toBe('✓');
    });

    it('should position icon correctly', async () => {
      container.innerHTML = '<ds-button icon="arrow-right" icon-position="right" text="Next"></ds-button>';
      const button = container.querySelector('ds-button') as DSButton;
      
      await button.updateComplete;
      
      expect(button.iconPosition).toBe('right');
      // Icon should appear after text in DOM
      const buttonContent = button.shadowRoot?.querySelector('button')?.innerHTML;
      expect(buttonContent?.indexOf('Next')).toBeLessThan(buttonContent?.indexOf('→') || 0);
    });

    it('should handle full-width property', async () => {
      container.innerHTML = '<ds-button full-width></ds-button>';
      const button = container.querySelector('ds-button') as DSButton;
      
      await button.updateComplete;
      
      expect(button.fullWidth).toBe(true);
      expect(button.hasAttribute('full-width')).toBe(true);
    });
  });

  describe('Custom Properties', () => {
    it('should apply custom colors when provided', async () => {
      container.innerHTML = '<ds-button primary-color="#ff0000" hover-color="#cc0000"></ds-button>';
      const button = container.querySelector('ds-button') as DSButton;
      
      await button.updateComplete;
      
      expect(button.primaryColor).toBe('#ff0000');
      expect(button.hoverColor).toBe('#cc0000');
      
      const computedStyle = getComputedStyle(button);
      expect(computedStyle.getPropertyValue('--primary-color')).toBe('#ff0000');
      expect(computedStyle.getPropertyValue('--hover-color')).toBe('#cc0000');
    });

    it('should apply custom border radius', async () => {
      container.innerHTML = '<ds-button border-radius="10"></ds-button>';
      const button = container.querySelector('ds-button') as DSButton;
      
      await button.updateComplete;
      
      expect(button.borderRadius).toBe(10);
      
      const computedStyle = getComputedStyle(button);
      expect(computedStyle.getPropertyValue('--border-radius')).toBe('10px');
    });
  });

  describe('Accessibility', () => {
    it('should have proper button semantics', async () => {
      container.innerHTML = '<ds-button text="Submit Form"></ds-button>';
      const button = container.querySelector('ds-button') as DSButton;
      
      await button.updateComplete;
      
      const shadowButton = button.shadowRoot?.querySelector('button');
      expect(shadowButton?.tagName).toBe('BUTTON');
      expect(shadowButton?.getAttribute('part')).toBe('button');
    });

    it('should be keyboard accessible', async () => {
      container.innerHTML = '<ds-button></ds-button>';
      const button = container.querySelector('ds-button') as DSButton;
      
      await button.updateComplete;
      
      const shadowButton = button.shadowRoot?.querySelector('button');
      
      // Should be focusable
      shadowButton?.focus();
      expect(document.activeElement).toBe(button);
    });
  });
});