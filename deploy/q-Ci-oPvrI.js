import{l as o}from"./q-LxAoK_V4.js";import*as n from"@sentry/browser";import"./q-BFBoRxOI.js";import"@supabase/supabase-js";import"zod";import"dompurify";class l{constructor(){this.initialized=!1;const e=typeof process<"u",r=e?process.env.NODE_ENV!=="production":window.location.hostname==="localhost";this.config={dsn:e?process.env.SENTRY_DSN:"https://c61059fda17fdf0a9baa21e9b8673f22@o4509594523205632.ingest.de.sentry.io/4509594591690832",environment:e&&process.env.SENTRY_ENVIRONMENT||"development",release:e&&process.env.APP_VERSION||"1.0.0",sampleRate:r?1:.1,tracesSampleRate:r?1:.1,enablePerformanceMonitoring:!0,enableUserFeedback:!0}}initialize(){if(!(this.initialized||typeof window>"u")){if(!this.config.dsn){o.info("Sentry DSN not configured, skipping initialization",{environment:this.config.environment});return}try{n.init({dsn:this.config.dsn,environment:this.config.environment,release:this.config.release,sampleRate:this.config.sampleRate,tracesSampleRate:this.config.tracesSampleRate,replaysSessionSampleRate:this.config.environment==="development"?.1:.01,replaysOnErrorSampleRate:1,integrations:[...this.config.environment==="production"?[new n.BrowserTracing,new n.Replay({maskAllText:!0,blockAllMedia:!0})]:[]],beforeSend:(e,r)=>{if(this.config.environment==="development"){const t=r.originalException;if(t instanceof Error&&["ResizeObserver loop limit exceeded","Non-Error promise rejection captured","Script error","Network request failed"].some(s=>t.message.includes(s)))return null}return e.tags&&(e.tags={...e.tags,component:"qwik-lit-builder",platform:"web"}),e},beforeSendTransaction:e=>{var r;return this.config.environment==="development"&&(r=e.transaction)!=null&&r.includes("/_build/")?null:e}}),this.initialized=!0,o.info("Sentry error tracking initialized",{environment:this.config.environment,release:this.config.release})}catch(e){o.error("Failed to initialize Sentry",{},e instanceof Error?e:new Error(String(e)))}}}captureError(e,r){if(this.initialized)try{return n.captureException(e,{tags:{component:(r==null?void 0:r.component)||"unknown",category:(r==null?void 0:r.category)||"error"},extra:r,level:this.mapSeverityToLevel(r==null?void 0:r.severity)})}catch(t){o.error("Failed to capture error in Sentry",{},t instanceof Error?t:new Error(String(t)));return}}captureMessage(e,r="info",t){if(this.initialized)try{return n.captureMessage(e,{level:r,tags:{component:(t==null?void 0:t.component)||"unknown"},extra:t})}catch(i){o.error("Failed to capture message in Sentry",{},i instanceof Error?i:new Error(String(i)));return}}setUser(e){if(this.initialized)try{n.setUser(e)}catch(r){o.error("Failed to set Sentry user",{},r instanceof Error?r:new Error(String(r)))}}setContext(e,r){if(this.initialized)try{n.setContext(e,r)}catch(t){o.error("Failed to set Sentry context",{key:e},t instanceof Error?t:new Error(String(t)))}}addBreadcrumb(e,r,t){if(this.initialized)try{n.addBreadcrumb({message:e,category:r,data:t,timestamp:Date.now()/1e3,level:"info"})}catch(i){o.error("Failed to add Sentry breadcrumb",{message:e,category:r},i instanceof Error?i:new Error(String(i)))}}startTransaction(e,r){if(!this.initialized)return null;try{return n.startTransaction({name:e,op:r})}catch(t){return o.error("Failed to start Sentry transaction",{name:e,op:r},t instanceof Error?t:new Error(String(t))),null}}showUserFeedbackDialog(e){if(!(!this.initialized||!this.config.enableUserFeedback))try{const r=(e==null?void 0:e.eventId)||n.lastEventId();r&&n.showReportDialog({eventId:r})}catch(r){o.error("Failed to show Sentry feedback dialog",{},r instanceof Error?r:new Error(String(r)))}}mapSeverityToLevel(e){switch(e){case"critical":return"fatal";case"high":return"error";case"medium":return"warning";case"low":return"info";default:return"error"}}measurePageLoad(){if(!(!this.initialized||!this.config.enablePerformanceMonitoring))try{typeof window<"u"&&"performance"in window&&new PerformanceObserver(r=>{for(const t of r.getEntries())t.entryType==="measure"&&n.addBreadcrumb({category:"performance",message:`${t.name}: ${t.duration}ms`,level:"info",data:{duration:t.duration,startTime:t.startTime}})}).observe({entryTypes:["measure","navigation"]})}catch(e){o.error("Failed to set up performance monitoring",{},e instanceof Error?e:new Error(String(e)))}}reportPerformanceMetric(e,r,t="ms"){if(this.initialized)try{n.addBreadcrumb({category:"performance",message:`${e}: ${r}${t}`,level:"info",data:{metric:e,value:r,unit:t}}),n.setTag(`perf.${e}`,r)}catch(i){o.error("Failed to report performance metric",{name:e,value:r},i instanceof Error?i:new Error(String(i)))}}}const d=new l;function f(c,e){return d.captureError(c,e)}function m(c,e,r){d.addBreadcrumb(c,e,r)}class a{constructor(){this.errorReports=[],this.maxReports=100,this.setupGlobalHandlers()}static getInstance(){return a.instance||(a.instance=new a),a.instance}setupGlobalHandlers(){typeof window<"u"&&(window.addEventListener("error",e=>{this.handleError(e.error,{category:"system",severity:"high",metadata:{filename:e.filename,lineno:e.lineno,colno:e.colno}})}),window.addEventListener("unhandledrejection",e=>{this.handleError(new Error(e.reason),{category:"system",severity:"high",metadata:{type:"unhandledrejection",reason:e.reason}})}),window.addEventListener("offline",()=>{this.handleError(new Error("Network offline"),{category:"network",severity:"medium",metadata:{type:"offline"}})}))}handleError(e,r){var s;const t={timestamp:new Date,route:typeof window<"u"?window.location.pathname:void 0,userAgent:typeof navigator<"u"?navigator.userAgent:void 0,...r.context,metadata:{...(s=r.context)==null?void 0:s.metadata,...r.metadata}},i={error:e,context:t,severity:r.severity,category:r.category};this.recordError(i),this.reportError(i),this.attemptRecovery(i)}recordError(e){if(this.errorReports.unshift(e),this.errorReports.length>this.maxReports&&(this.errorReports=this.errorReports.slice(0,this.maxReports)),e.severity==="critical"&&typeof localStorage<"u")try{const r=JSON.parse(localStorage.getItem("critical_errors")||"[]");r.unshift({message:e.error.message,stack:e.error.stack,context:e.context,timestamp:e.context.timestamp.toISOString()}),localStorage.setItem("critical_errors",JSON.stringify(r.slice(0,10)))}catch{}}async reportError(e){var i;if(e.error.message.includes("Failed to report error")||e.error.message.includes("fetch")||e.error.message.includes("SyntaxError: Invalid or unexpected token")||(i=e.context.metadata)!=null&&i.isErrorReportingError)return;m(`${e.category.toUpperCase()} Error occurred`,"error",{severity:e.severity,route:e.context.route,userId:e.context.userId,...e.context.metadata});const r=f(e.error,{category:e.category,severity:e.severity,component:"error-handler",...e.context.metadata}),t=e.severity==="critical"?"critical":e.severity==="high"?"error":e.severity==="medium"?"warn":"info";o.log(t,`${e.category.toUpperCase()} Error: ${e.error.message}`,{category:e.category,severity:e.severity,userId:e.context.userId,sessionId:e.context.sessionId,route:e.context.route,sentryEventId:r,...e.context.metadata},e.error);try{typeof fetch<"u"&&await fetch("/api/errors",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:e.error.message,stack:e.error.stack,context:e.context,severity:e.severity,category:e.category,sentryEventId:r})})}catch(s){o.error("Failed to report error to API",{originalError:e.error.message},s instanceof Error?s:new Error(String(s)))}}attemptRecovery(e){var r;switch(e.category){case"network":(r=e.context.metadata)!=null&&r.retryable&&setTimeout(()=>{typeof window<"u"&&navigator.onLine&&window.location.reload()},5e3);break;case"data":typeof localStorage<"u"&&(localStorage.removeItem("app_cache"),localStorage.removeItem("user_data"));break;case"ui":e.severity==="critical"&&setTimeout(()=>{typeof window<"u"&&(window.location.href="/")},3e3);break}}getRecentErrors(e=10){return this.errorReports.slice(0,e)}clearErrors(){this.errorReports=[],typeof localStorage<"u"&&localStorage.removeItem("critical_errors")}static handleUIError(e,r){a.getInstance().handleError(e,{category:"ui",severity:"medium",context:r})}static handleAPIError(e,r){a.getInstance().handleError(e,{category:"api",severity:"high",context:r})}static handleAuthError(e,r){a.getInstance().handleError(e,{category:"auth",severity:"high",context:r})}static handleDataError(e,r){a.getInstance().handleError(e,{category:"data",severity:"high",context:r})}static handleCriticalError(e,r){a.getInstance().handleError(e,{category:"system",severity:"critical",context:r})}}a.getInstance();const{handleUIError:E}=a;export{a as GlobalErrorHandler,E as handleUIError};
